<!DOCTYPE html>
<html>
<head>
<title>Sand Simulator</title>
<style>
body {
  margin: 0;
  overflow: hidden;
  background: black;
}
canvas {
  display: block;
}
</style>
</head>

<body>
<canvas id="canvas"></canvas>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const size = 4; // pixel size
const cols = Math.floor(canvas.width / size);
const rows = Math.floor(canvas.height / size);

let grid = [];

function resetGrid() {
  grid = [];
  for (let y = 0; y < rows; y++) {
    grid[y] = [];
    for (let x = 0; x < cols; x++) {
      grid[y][x] = 0;
    }
  }
}

resetGrid();

let dropping = false;

canvas.addEventListener("mousedown", () => dropping = true);
canvas.addEventListener("mouseup", () => dropping = false);
canvas.addEventListener("mousemove", e => {
  if (!dropping) return;

  let x = Math.floor(e.clientX / size);
  let y = Math.floor(e.clientY / size);

  for (let i = -2; i <= 2; i++) {
    for (let j = -2; j <= 2; j++) {
      if (grid[y + j] && grid[y + j][x + i] !== undefined) {
        grid[y + j][x + i] = 1;
      }
    }
  }
});

document.addEventListener("keydown", e => {
  if (e.key === "c") resetGrid();
});

function update() {
  for (let y = rows - 2; y >= 0; y--) {
    for (let x = 0; x < cols; x++) {
      if (grid[y][x] === 1) {

        if (grid[y + 1][x] === 0) {
          grid[y][x] = 0;
          grid[y + 1][x] = 1;
        } else {
          let dir = Math.random() < 0.5 ? -1 : 1;
          if (grid[y + 1][x + dir] === 0) {
            grid[y][x] = 0;
            grid[y + 1][x + dir] = 1;
          }
        }
      }
    }
  }
}

function draw() {
  ctx.fillStyle = "black";
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  ctx.fillStyle = "gold";

  for (let y = 0; y < rows; y++) {
    for (let x = 0; x < cols; x++) {
      if (grid[y][x] === 1) {
        ctx.fillRect(x * size, y * size, size, size);
      }
    }
  }
}

function loop() {
  update();
  draw();
  requestAnimationFrame(loop);
}

loop();
</script>
</body>
</html>
